(()=>{"use strict";var e,t;!function(e){e.FROM_PAGE="FROM_PAGE",e.FROM_EXTENSION="FROM_EXTENSION",e.FROM_BG="FROM_BG",e.FROM_CONTENT="FROM_CONTENT"}(e||(e={})),function(e){e.EXT_LOST_CONNECTION="EXT_LOST_CONNECTION",e.EXT_CHECK="EXT_CHECK",e.EXT_PRESENT="EXT_PRESENT",e.SEND_PROMPT="SEND_PROMPT",e.GET_PROOF_TOKEN="GET_PROOF_TOKEN",e.GET_BROWSER_INFO="GET_BROWSER_INFO",e.SSE_PART="SSE_PART",e.SSE_DONE="SSE_DONE",e.SSE_ERROR="SSE_ERROR",e.GPT_STREAM_PART="GPT_STREAM_PART",e.GPT_STREAM_DONE="GPT_STREAM_DONE",e.GPT_STREAM_ERROR="GPT_STREAM_ERROR"}(t||(t={}));const n="https://chatgpt.com",o=n+"/backend-api",r="gpt",i="clientId";let a=null,c=null,s=null;function u(){return a}function l(e){a=e}function d(){return c}function h(e){s=e}function f(e={},t=0){return function(e={},t=null,n=0){if(crypto.randomUUID&&!t&&!e.random&&!e.rng)return crypto.randomUUID();const o=e.random||(e.rng||(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),e}))();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return _[e[t+0]]+_[e[t+1]]+_[e[t+2]]+_[e[t+3]]+"-"+_[e[t+4]]+_[e[t+5]]+"-"+_[e[t+6]]+_[e[t+7]]+"-"+_[e[t+8]]+_[e[t+9]]+"-"+_[e[t+10]]+_[e[t+11]]+_[e[t+12]]+_[e[t+13]]+_[e[t+14]]+_[e[t+15]]}(o)}(e,null,t)}const _=Array.from({length:256},((e,t)=>(t+256).toString(16).slice(1)));function p(t){return Object.assign({type:e.FROM_BG},t)}function g(e){return e.replace(`${r}_`,"")}function m(e){return`${r}_${e}`}var v=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function y(e,t,n){const o=p(Object.assign({action:t},n));return chrome.tabs.sendMessage(e,o)}var E=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function T(){return E(this,void 0,void 0,(function*(){return(yield function(e){return E(this,void 0,void 0,(function*(){const t=m(e),n=yield O(t);return{[e]:n[t]}}))}(i)).clientId||""}))}function O(e){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)}))}))}function R(){return E(this,void 0,void 0,(function*(){try{const e=yield T();if(e)return e;const t=f();return yield function(e){return E(this,void 0,void 0,(function*(){return yield chrome.storage.local.set({[m(i)]:e}),e}))}(t),t}catch(e){throw e}}))}var S=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function w(e){return S(this,void 0,void 0,(function*(){var i,a,c,s,d,h,_,m,R;try{const[w]=yield chrome.tabs.query({active:!0,currentWindow:!0}),N=yield function(){return E(this,void 0,void 0,(function*(){const e=yield O(null),t={};for(const n in e)n.startsWith(r)&&(t[g(n)]=e[n]);return t}))}();if(!N.authorization||!N.oaiClientVersion)return P(),y(w.id,t.SSE_PART,{error:!0,content:"Thiếu token. Hãy đăng nhập lại chatgpt."}).catch((e=>{console.log({error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại...",err:e})})),{error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại..."};const b=f(),A=function(e){e&&!e.startsWith("Bearer ")&&(e="Bearer "+e);return{"Content-Type":"application/json",Authorization:`${e}`,origin:n,referer:`${n}/`}}(N.authorization),M=Object.assign(Object.assign({},A),{Accept:"text/event-stream"});M["oai-client-version"]=N.oaiClientVersion,N.userAgent&&(M["User-Agent"]=N.userAgent),N.oaiLanguage&&(M["oai-language"]=N.oaiLanguage),M["oai-device-id"]=yield T();const C=yield function(e){return S(this,void 0,void 0,(function*(){const t=yield T();return(yield fetch(`${o}/sentinel/chat-requirements`,{method:"POST",headers:Object.assign(Object.assign({},e),{Accept:"application/json","Content-Type":"application/json","oai-device-id":t}),body:JSON.stringify({conversationMode:{kind:"primary_assistant"}})})).json()}))}(M);M["openai-sentinel-chat-requirements-token"]=C.token;const x=yield(m=C.proofofwork.seed,R=C.proofofwork.difficulty,new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(n=>{var o;(null===(o=n[0])||void 0===o?void 0:o.id)?y(n[0].id,t.GET_PROOF_TOKEN,{params:[m,R]}).then((t=>{e(t)})).catch((t=>{console.log("getProofToken err",t),e("")})):e("")}))})));M["openai-sentinel-proof-token"]=x;const G=yield function(){return v(this,void 0,void 0,(function*(){let e=u();return e||new Promise((n=>{const o=setTimeout((()=>{e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},l(e),n(e)}),1e3);chrome.tabs.query({active:!0,currentWindow:!0},(r=>{if(chrome.runtime.lastError||!r.length)return clearTimeout(o),e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},l(e),n(e);chrome.tabs.sendMessage(r[0].id,p({action:t.GET_BROWSER_INFO}),(t=>{if(clearTimeout(o),chrome.runtime.lastError||!t)return e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},l(e),n(e);e=t,n(t)}))}))}))}))}(),k={action:"next",messages:[{id:b,author:{role:"user"},create_time:Date.now()/1e3,content:{content_type:"text",parts:[e.prompt]},metadata:{selected_github_repos:[],selected_all_github_repos:!1,serialization_metadata:{custom_symbol_offsets:[]}}}],parent_message_id:"client-created-root",model:"auto",timezone_offset_min:(new Date).getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,conversation_mode:{kind:"primary_assistant"},enable_message_followups:!0,system_hints:[],supports_buffering:!0,supported_encodings:["v1"],client_contextual_info:{is_dark_mode:!0,time_since_loaded:performance.now()/1e3,page_height:G.page_height,page_width:G.page_width,pixel_ratio:G.pixel_ratio,screen_height:G.screen_height,screen_width:G.screen_width},paragen_cot_summary_display_override:"allow"},F=yield fetch(`${o}/conversation`,{method:"POST",headers:M,body:JSON.stringify(k),credentials:"include"});if(401===F.status)return P(),{error:"Token expired, opened chatgpt.com to refresh token"};const I=F.headers.get("content-type");if(200!==F.status){let e=null;return"application/json"===I&&(e=yield F.json()),y(w.id,t.SSE_PART,{error:!0,content:null==e?void 0:e.detail}).catch((e=>{console.log("SendMessage lỗi:",e)})),{success:!1,error:e}}const j=F.body.getReader(),D=new TextDecoder("utf-8");let L="",z="";for(;;){const{done:e,value:n}=yield j.read();if(e)break;L+=D.decode(n,{stream:!0});const o=L.split("\n\n");L=o.pop()||"";for(const e of o){const n=e.trim().split("\n");let o=null;const r=[];for(const e of n)e.startsWith("event:")?o=e.slice(6).trim():e.startsWith("data:")&&r.push(e.slice(6).trim());const u=r.join("\n");if("[DONE]"===u)break;if(u)try{const e=JSON.parse(u);if("user"===(null===(c=null===(a=null===(i=e.v)||void 0===i?void 0:i.message)||void 0===a?void 0:a.author)||void 0===c?void 0:c.role))continue;let n=null;if((null===(_=null===(h=null===(d=null===(s=e.v)||void 0===s?void 0:s.message)||void 0===d?void 0:d.content)||void 0===h?void 0:h.parts)||void 0===_?void 0:_.length)>0)n=e.v.message.content.parts[0];else if("string"==typeof e.v)n=e.v;else if(e.p&&"append"===e.o&&"string"==typeof e.v)n=e.v;else if("patch"===(null==e?void 0:e.o)&&Array.isArray(e.v)){const t=e.v[0];"append"===t.o&&"string"==typeof t.v&&(n=t.v)}n&&(z+=n,y(w.id,t.SSE_PART,{content:n}).catch((e=>{console.log("SendMessage lỗi:",e)})))}catch(e){console.warn("Có lỗi xảy ra:",e)}}}return{success:!0}}catch(e){return console.log(e),{error:e.message||e}}}))}function P(){const e=d();null!==e?chrome.tabs.get(e,(t=>{chrome.runtime.lastError||!t?N():(chrome.tabs.reload(e),chrome.tabs.update(e,{active:!1}))})):N()}function N(){chrome.tabs.create({url:n,active:!1},(e=>{var t;void 0!==e.id&&(t=e.id,c=t)}))}var b=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};chrome.webRequest.onBeforeSendHeaders.addListener((e=>{const t=e.requestHeaders||[];if(e.initiator===n)return e.url===`${n}/auth/logout`&&chrome.storage.local.set({[`${r}_authorization`]:""}),function(e){const t=["authorization","oai-client-version","user-agent","accept-language","oai-language"],n={};return e.forEach((e=>{const o=(e=>e.name.toLowerCase())(e);if(t.includes(o)&&e.value){const t=e.name.toLowerCase().replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase())).replace(/ /g,"").replace(/^\w/,(e=>e.toLowerCase()));n[m(t)]=e.value}})),Object.keys(n).length>0&&chrome.storage.local.set(n),{requestHeaders:e}}(t)}),{urls:[`${n}/*`]},["requestHeaders"]),chrome.runtime.onInstalled.addListener((()=>b(void 0,void 0,void 0,(function*(){const e=yield R();h(e),console.log("ClientId initialized:",e)})))),chrome.runtime.onStartup.addListener((()=>b(void 0,void 0,void 0,(function*(){const e=yield R();h(e),console.log("ClientId ready on startup:",e)})))),chrome.runtime.onMessage.addListener(((n,o,r)=>{if(n.type===e.FROM_CONTENT)return n.action===t.SEND_PROMPT?(w(n).then((e=>{r(e)})).catch((e=>{r({error:e.message||e})})),!0):void 0}))})();