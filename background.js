(()=>{"use strict";var e,t;!function(e){e.FROM_PAGE="FROM_PAGE",e.FROM_EXTENSION="FROM_EXTENSION",e.FROM_BG="FROM_BG",e.FROM_CONTENT="FROM_CONTENT"}(e||(e={})),function(e){e.EXT_LOST_CONNECTION="EXT_LOST_CONNECTION",e.EXT_CHECK="EXT_CHECK",e.EXT_PRESENT="EXT_PRESENT",e.SEND_PROMPT="SEND_PROMPT",e.GET_PROOF_TOKEN="GET_PROOF_TOKEN",e.GET_BROWSER_INFO="GET_BROWSER_INFO",e.SSE_PART="SSE_PART",e.SSE_DONE="SSE_DONE",e.SSE_ERROR="SSE_ERROR",e.GPT_STREAM_PART="GPT_STREAM_PART",e.GPT_STREAM_DONE="GPT_STREAM_DONE",e.GPT_STREAM_ERROR="GPT_STREAM_ERROR"}(t||(t={}));const n="https://chatgpt.com",o=n+"/backend-api",i="gpt",r="clientId",a="conversation_id",c="current_message_id",s="message_count";let u=null,l=null,d=null;function h(){return u}function f(e){u=e}function _(){return l}function v(e){d=e}function g(e={},t=0){return function(e={},t=null,n=0){if(crypto.randomUUID&&!t&&!e.random&&!e.rng)return crypto.randomUUID();const o=e.random||(e.rng||(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),e}))();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]}(o)}(e,null,t)}const p=Array.from({length:256},((e,t)=>(t+256).toString(16).slice(1)));function m(t){return Object.assign({type:e.FROM_BG},t)}function y(e){return e.replace(`${i}_`,"")}function E(e){return`${i}_${e}`}var T=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{s(o.next(e))}catch(e){r(e)}}function c(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function O(e,t,n){const o=m(Object.assign({action:t},n));return chrome.tabs.sendMessage(e,o)}var R=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{s(o.next(e))}catch(e){r(e)}}function c(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function w(){return R(this,void 0,void 0,(function*(){return(yield function(e){return R(this,void 0,void 0,(function*(){const t=E(e),n=yield S(t);return{[e]:n[t]}}))}(r)).clientId||""}))}function S(e){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)}))}))}function P(){return R(this,void 0,void 0,(function*(){try{const e=yield w();if(e)return e;const t=g();return yield function(e){return R(this,void 0,void 0,(function*(){return yield chrome.storage.local.set({[E(r)]:e}),e}))}(t),t}catch(e){throw e}}))}function N(e){const t={};for(const n in e){const o=e[n];t[E(n)]=o}chrome.storage.local.set(t)}var b=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{s(o.next(e))}catch(e){r(e)}}function c(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function A(e){return b(this,void 0,void 0,(function*(){var r,u,l,d,_;try{const[v]=yield chrome.tabs.query({active:!0,currentWindow:!0}),p=v.id,E=yield function(){return R(this,void 0,void 0,(function*(){const e=yield S(null),t={};for(const n in e)n.startsWith(i)&&(t[y(n)]=e[n]);return t}))}();if(!(yield function(e,n){return b(this,void 0,void 0,(function*(){return!(!e.authorization||!e.oaiClientVersion)||(M(),yield O(n,t.SSE_PART,{error:!0,content:"Thiếu token. Hãy đăng nhập lại chatgpt."}),!1)}))}(E,p)))return{error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại..."};let P=E.conversation_id||null,A=E.current_message_id||"client-created-root",C=E.message_count?parseInt(E.message_count):0;C>10&&(P=null,C=0,A="client-created-root");const x=g(),k=function(e){e&&!e.startsWith("Bearer ")&&(e="Bearer "+e);return{"Content-Type":"application/json",Authorization:`${e}`,origin:n,referer:`${n}/`}}(E.authorization),F=Object.assign(Object.assign({},k),{Accept:"text/event-stream"});F["oai-client-version"]=E.oaiClientVersion,E.userAgent&&(F["User-Agent"]=E.userAgent),E.oaiLanguage&&(F["oai-language"]=E.oaiLanguage),F["oai-device-id"]=yield w();const G=yield function(e){return b(this,void 0,void 0,(function*(){const t=yield w(),n=yield fetch(`${o}/sentinel/chat-requirements`,{method:"POST",headers:Object.assign(Object.assign({},e),{Accept:"application/json","Content-Type":"application/json","oai-device-id":t}),body:JSON.stringify({conversationMode:{kind:"primary_assistant"}})});if(!n.ok){let e=null;try{e=yield n.json(),(null==e?void 0:e.detail)&&(e=e.detail)}catch(t){e=yield n.text()}throw new Error(e||"Failed to fetch chat requirements")}return n.json()}))}(F);F["openai-sentinel-chat-requirements-token"]=G.token;const I=yield(d=G.proofofwork.seed,_=G.proofofwork.difficulty,new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(n=>{var o;(null===(o=n[0])||void 0===o?void 0:o.id)?O(n[0].id,t.GET_PROOF_TOKEN,{params:[d,_]}).then((t=>{e(t)})).catch((t=>{console.log("getProofToken err",t),e("")})):e("")}))})));F["openai-sentinel-proof-token"]=I;const j=yield function(){return T(this,void 0,void 0,(function*(){let e=h();return e||new Promise((n=>{const o=setTimeout((()=>{e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},f(e),n(e)}),1e3);chrome.tabs.query({active:!0,currentWindow:!0},(i=>{if(chrome.runtime.lastError||!i.length)return clearTimeout(o),e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},f(e),n(e);chrome.tabs.sendMessage(i[0].id,m({action:t.GET_BROWSER_INFO}),(t=>{if(clearTimeout(o),chrome.runtime.lastError||!t)return e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},f(e),n(e);e=t,n(t)}))}))}))}))}(),D=function(e,t,n,o,i){return{action:"next",messages:[{id:i,author:{role:"user"},create_time:Date.now()/1e3,content:{content_type:"text",parts:[e.prompt]},metadata:{selected_github_repos:[],selected_all_github_repos:!1,serialization_metadata:{custom_symbol_offsets:[]}}}],parent_message_id:o,model:"auto",timezone_offset_min:(new Date).getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,conversation_id:n,conversation_mode:{kind:"primary_assistant"},enable_message_followups:!0,system_hints:[],supports_buffering:!0,supported_encodings:["v1"],client_contextual_info:{is_dark_mode:!0,time_since_loaded:performance.now()/1e3,page_height:t.page_height,page_width:t.page_width,pixel_ratio:t.pixel_ratio,screen_height:t.screen_height,screen_width:t.screen_width},paragen_cot_summary_display_override:"allow"}}(e,j,P,A,x),L=yield fetch(`${o}/conversation`,{method:"POST",headers:F,body:JSON.stringify(D),credentials:"include"});if(401===L.status)return M(),{error:"Token expired, opened chatgpt.com to refresh token"};const q=L.headers.get("content-type");if(200!==L.status){let e=null;return"application/json"===q&&(e=yield L.json()),yield O(p,t.SSE_PART,{error:!0,content:(null===(r=null==e?void 0:e.detail)||void 0===r?void 0:r.message)||(null==e?void 0:e.detail)}).catch((e=>{console.log("SendMessage lỗi:",e)})),{success:!1,error:e}}C+=1,u=s,l=C,N({[u]:l});const z=L.body.getReader();return yield function(e,n){return b(this,void 0,void 0,(function*(){var o,i,r,s,u,l,d,h,f,_;const v=new TextDecoder("utf-8");let g="",p="";for(;;){const{done:m,value:y}=yield e.read();if(m)break;g+=v.decode(y,{stream:!0});const E=g.split("\n\n");g=E.pop()||"";for(const e of E){const v=e.trim().split("\n");let g=null;const m=[];for(const e of v)e.startsWith("event:")?g=e.slice(6).trim():e.startsWith("data:")&&m.push(e.slice(6).trim());const y=m.join("\n");if("[DONE]"===y)break;if(y)try{const e=JSON.parse(y);if((null===(o=e.v)||void 0===o?void 0:o.conversation_id)&&N({[a]:e.v.conversation_id}),(null===(r=null===(i=e.v)||void 0===i?void 0:i.message)||void 0===r?void 0:r.id)&&N({[c]:e.v.message.id}),"user"===(null===(l=null===(u=null===(s=e.v)||void 0===s?void 0:s.message)||void 0===u?void 0:u.author)||void 0===l?void 0:l.role))continue;let v=null;if((null===(_=null===(f=null===(h=null===(d=e.v)||void 0===d?void 0:d.message)||void 0===h?void 0:h.content)||void 0===f?void 0:f.parts)||void 0===_?void 0:_.length)>0)v=e.v.message.content.parts[0];else if("string"==typeof e.v)v=e.v;else if(e.p&&"append"===e.o&&"string"==typeof e.v)v=e.v;else if("patch"===(null==e?void 0:e.o)&&Array.isArray(e.v)){const t=e.v[0];"append"===t.o&&"string"==typeof t.v&&(v=t.v)}v&&(p+=v,yield O(n,t.SSE_PART,{content:v}))}catch(e){console.warn("Có lỗi xảy ra:",e)}}}return p}))}(z,p),{success:!0}}catch(e){return console.log(e),{error:e.message||e}}}))}function M(){const e=_();null!==e?chrome.tabs.get(e,(t=>{chrome.runtime.lastError||!t?C():(chrome.tabs.reload(e),chrome.tabs.update(e,{active:!1}))})):C()}function C(){chrome.tabs.create({url:n,active:!1},(e=>{var t;void 0!==e.id&&(t=e.id,l=t)}))}var x=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{s(o.next(e))}catch(e){r(e)}}function c(e){try{s(o.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};chrome.webRequest.onBeforeSendHeaders.addListener((e=>{const t=e.requestHeaders||[];if(e.initiator===n)return e.url===`${n}/auth/logout`&&chrome.storage.local.set({[`${i}_authorization`]:""}),function(e){const t=["authorization","oai-client-version","user-agent","accept-language","oai-language"],n={};return e.forEach((e=>{const o=(e=>e.name.toLowerCase())(e);if(t.includes(o)&&e.value){const t=e.name.toLowerCase().replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase())).replace(/ /g,"").replace(/^\w/,(e=>e.toLowerCase()));n[E(t)]=e.value}})),Object.keys(n).length>0&&chrome.storage.local.set(n),{requestHeaders:e}}(t)}),{urls:[`${n}/*`]},["requestHeaders"]),chrome.runtime.onInstalled.addListener((()=>x(void 0,void 0,void 0,(function*(){const e=yield P();v(e),console.log("ClientId initialized:",e)})))),chrome.runtime.onStartup.addListener((()=>x(void 0,void 0,void 0,(function*(){const e=yield P();v(e),console.log("ClientId ready on startup:",e)})))),chrome.runtime.onMessage.addListener(((n,o,i)=>{if(n.type===e.FROM_CONTENT)return n.action===t.SEND_PROMPT?(A(n).then((e=>{i(e)})).catch((e=>{i({error:e.message||e})})),!0):void 0}))})();