(()=>{"use strict";var e,t;!function(e){e.FROM_PAGE="FROM_PAGE",e.FROM_EXTENSION="FROM_EXTENSION",e.FROM_BG="FROM_BG",e.FROM_CONTENT="FROM_CONTENT"}(e||(e={})),function(e){e.EXT_LOST_CONNECTION="EXT_LOST_CONNECTION",e.EXT_CHECK="EXT_CHECK",e.EXT_PRESENT="EXT_PRESENT",e.SEND_PROMPT="SEND_PROMPT",e.GET_PROOF_TOKEN="GET_PROOF_TOKEN",e.GET_BROWSER_INFO="GET_BROWSER_INFO",e.SSE_PART="SSE_PART",e.SSE_DONE="SSE_DONE",e.SSE_ERROR="SSE_ERROR",e.GPT_STREAM_PART="GPT_STREAM_PART",e.GPT_STREAM_DONE="GPT_STREAM_DONE",e.GPT_STREAM_ERROR="GPT_STREAM_ERROR"}(t||(t={}));const n="https://chatgpt.com",o=n+"/backend-api",r="gpt",i="clientId",a="conversation_id",c="current_message_id",s="message_count";let u=null,l=null,d=null;function h(){return u}function _(e){u=e}function f(){return l}function v(e){d=e}function g(e={},t=0){return function(e={},t=null,n=0){if(crypto.randomUUID&&!t&&!e.random&&!e.rng)return crypto.randomUUID();const o=e.random||(e.rng||(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),e}))();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return p[e[t+0]]+p[e[t+1]]+p[e[t+2]]+p[e[t+3]]+"-"+p[e[t+4]]+p[e[t+5]]+"-"+p[e[t+6]]+p[e[t+7]]+"-"+p[e[t+8]]+p[e[t+9]]+"-"+p[e[t+10]]+p[e[t+11]]+p[e[t+12]]+p[e[t+13]]+p[e[t+14]]+p[e[t+15]]}(o)}(e,null,t)}const p=Array.from({length:256},((e,t)=>(t+256).toString(16).slice(1)));function m(t){return Object.assign({type:e.FROM_BG},t)}function y(e){return e.replace(`${r}_`,"")}function E(e){return`${r}_${e}`}var T=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function O(e,t,n){const o=m(Object.assign({action:t},n));return chrome.tabs.sendMessage(e,o)}var R=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function S(){return R(this,void 0,void 0,(function*(){return(yield function(e){return R(this,void 0,void 0,(function*(){const t=E(e),n=yield w(t);return{[e]:n[t]}}))}(i)).clientId||""}))}function w(e){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)}))}))}function P(){return R(this,void 0,void 0,(function*(){try{const e=yield S();if(e)return e;const t=g();return yield function(e){return R(this,void 0,void 0,(function*(){return yield chrome.storage.local.set({[E(i)]:e}),e}))}(t),t}catch(e){throw e}}))}function N(e){const t={};for(const n in e){const o=e[n];t[E(n)]=o}chrome.storage.local.set(t)}var b=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};function A(e){return b(this,void 0,void 0,(function*(){var i,u,l,d,f,v,p,E,P,A,C,x,G,k,F;try{const[I]=yield chrome.tabs.query({active:!0,currentWindow:!0}),j=yield function(){return R(this,void 0,void 0,(function*(){const e=yield w(null),t={};for(const n in e)n.startsWith(r)&&(t[y(n)]=e[n]);return t}))}();if(!j.authorization||!j.oaiClientVersion)return M(),O(I.id,t.SSE_PART,{error:!0,content:"Thiếu token. Hãy đăng nhập lại chatgpt."}).catch((e=>{console.log({error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại...",err:e})})),{error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại..."};let D=j.conversation_id||null,L=j.current_message_id||"client-created-root",z=j.message_count?parseInt(j.message_count):0;z>10&&(D=null,z=0,L="client-created-root");const W=g(),$=function(e){e&&!e.startsWith("Bearer ")&&(e="Bearer "+e);return{"Content-Type":"application/json",Authorization:`${e}`,origin:n,referer:`${n}/`}}(j.authorization),q=Object.assign(Object.assign({},$),{Accept:"text/event-stream"});q["oai-client-version"]=j.oaiClientVersion,j.userAgent&&(q["User-Agent"]=j.userAgent),j.oaiLanguage&&(q["oai-language"]=j.oaiLanguage),q["oai-device-id"]=yield S();const B=yield function(e){return b(this,void 0,void 0,(function*(){const t=yield S();return(yield fetch(`${o}/sentinel/chat-requirements`,{method:"POST",headers:Object.assign(Object.assign({},e),{Accept:"application/json","Content-Type":"application/json","oai-device-id":t}),body:JSON.stringify({conversationMode:{kind:"primary_assistant"}})})).json()}))}(q);q["openai-sentinel-chat-requirements-token"]=B.token;const X=yield(k=B.proofofwork.seed,F=B.proofofwork.difficulty,new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(n=>{var o;(null===(o=n[0])||void 0===o?void 0:o.id)?O(n[0].id,t.GET_PROOF_TOKEN,{params:[k,F]}).then((t=>{e(t)})).catch((t=>{console.log("getProofToken err",t),e("")})):e("")}))})));q["openai-sentinel-proof-token"]=X;const H=yield function(){return T(this,void 0,void 0,(function*(){let e=h();return e||new Promise((n=>{const o=setTimeout((()=>{e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},_(e),n(e)}),1e3);chrome.tabs.query({active:!0,currentWindow:!0},(r=>{if(chrome.runtime.lastError||!r.length)return clearTimeout(o),e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},_(e),n(e);chrome.tabs.sendMessage(r[0].id,m({action:t.GET_BROWSER_INFO}),(t=>{if(clearTimeout(o),chrome.runtime.lastError||!t)return e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},_(e),n(e);e=t,n(t)}))}))}))}))}(),U={action:"next",messages:[{id:W,author:{role:"user"},create_time:Date.now()/1e3,content:{content_type:"text",parts:[e.prompt]},metadata:{selected_github_repos:[],selected_all_github_repos:!1,serialization_metadata:{custom_symbol_offsets:[]}}}],parent_message_id:L,model:"auto",timezone_offset_min:(new Date).getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,conversation_id:D,conversation_mode:{kind:"primary_assistant"},enable_message_followups:!0,system_hints:[],supports_buffering:!0,supported_encodings:["v1"],client_contextual_info:{is_dark_mode:!0,time_since_loaded:performance.now()/1e3,page_height:H.page_height,page_width:H.page_width,pixel_ratio:H.pixel_ratio,screen_height:H.screen_height,screen_width:H.screen_width},paragen_cot_summary_display_override:"allow"},K=yield fetch(`${o}/conversation`,{method:"POST",headers:q,body:JSON.stringify(U),credentials:"include"});if(401===K.status)return M(),{error:"Token expired, opened chatgpt.com to refresh token"};const J=K.headers.get("content-type");if(200!==K.status){let e=null;return"application/json"===J&&(e=yield K.json()),O(I.id,t.SSE_PART,{error:!0,content:(null===(i=null==e?void 0:e.detail)||void 0===i?void 0:i.message)||(null==e?void 0:e.detail)}).catch((e=>{console.log("SendMessage lỗi:",e)})),{success:!1,error:e}}z+=1,x=s,G=z,N({[x]:G});const V=K.body.getReader(),Z=new TextDecoder("utf-8");let Q="",Y="";for(;;){const{done:e,value:n}=yield V.read();if(e)break;Q+=Z.decode(n,{stream:!0});const o=Q.split("\n\n");Q=o.pop()||"";for(const e of o){const n=e.trim().split("\n");let o=null;const r=[];for(const e of n)e.startsWith("event:")?o=e.slice(6).trim():e.startsWith("data:")&&r.push(e.slice(6).trim());const i=r.join("\n");if("[DONE]"===i)break;if(i)try{const e=JSON.parse(i);if((null===(u=e.v)||void 0===u?void 0:u.conversation_id)&&N({[a]:e.v.conversation_id}),(null===(d=null===(l=e.v)||void 0===l?void 0:l.message)||void 0===d?void 0:d.id)&&N({[c]:e.v.message.id}),"user"===(null===(p=null===(v=null===(f=e.v)||void 0===f?void 0:f.message)||void 0===v?void 0:v.author)||void 0===p?void 0:p.role))continue;let n=null;if((null===(C=null===(A=null===(P=null===(E=e.v)||void 0===E?void 0:E.message)||void 0===P?void 0:P.content)||void 0===A?void 0:A.parts)||void 0===C?void 0:C.length)>0)n=e.v.message.content.parts[0];else if("string"==typeof e.v)n=e.v;else if(e.p&&"append"===e.o&&"string"==typeof e.v)n=e.v;else if("patch"===(null==e?void 0:e.o)&&Array.isArray(e.v)){const t=e.v[0];"append"===t.o&&"string"==typeof t.v&&(n=t.v)}n&&(Y+=n,O(I.id,t.SSE_PART,{content:n}).catch((e=>{console.log("SendMessage lỗi:",e)})))}catch(e){console.warn("Có lỗi xảy ra:",e)}}}return{success:!0}}catch(e){return console.log(e),{error:e.message||e}}}))}function M(){const e=f();null!==e?chrome.tabs.get(e,(t=>{chrome.runtime.lastError||!t?C():(chrome.tabs.reload(e),chrome.tabs.update(e,{active:!1}))})):C()}function C(){chrome.tabs.create({url:n,active:!1},(e=>{var t;void 0!==e.id&&(t=e.id,l=t)}))}var x=function(e,t,n,o){return new(n||(n=Promise))((function(r,i){function a(e){try{s(o.next(e))}catch(e){i(e)}}function c(e){try{s(o.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,c)}s((o=o.apply(e,t||[])).next())}))};chrome.webRequest.onBeforeSendHeaders.addListener((e=>{const t=e.requestHeaders||[];if(e.initiator===n)return e.url===`${n}/auth/logout`&&chrome.storage.local.set({[`${r}_authorization`]:""}),function(e){const t=["authorization","oai-client-version","user-agent","accept-language","oai-language"],n={};return e.forEach((e=>{const o=(e=>e.name.toLowerCase())(e);if(t.includes(o)&&e.value){const t=e.name.toLowerCase().replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase())).replace(/ /g,"").replace(/^\w/,(e=>e.toLowerCase()));n[E(t)]=e.value}})),Object.keys(n).length>0&&chrome.storage.local.set(n),{requestHeaders:e}}(t)}),{urls:[`${n}/*`]},["requestHeaders"]),chrome.runtime.onInstalled.addListener((()=>x(void 0,void 0,void 0,(function*(){const e=yield P();v(e),console.log("ClientId initialized:",e)})))),chrome.runtime.onStartup.addListener((()=>x(void 0,void 0,void 0,(function*(){const e=yield P();v(e),console.log("ClientId ready on startup:",e)})))),chrome.runtime.onMessage.addListener(((n,o,r)=>{if(n.type===e.FROM_CONTENT)return n.action===t.SEND_PROMPT?(A(n).then((e=>{r(e)})).catch((e=>{r({error:e.message||e})})),!0):void 0}))})();