(()=>{"use strict";var e,t;!function(e){e.FROM_PAGE="FROM_PAGE",e.FROM_EXTENSION="FROM_EXTENSION",e.FROM_BG="FROM_BG",e.FROM_CONTENT="FROM_CONTENT"}(e||(e={})),function(e){e.EXT_LOST_CONNECTION="EXT_LOST_CONNECTION",e.EXT_CHECK="EXT_CHECK",e.EXT_PRESENT="EXT_PRESENT",e.SEND_PROMPT="SEND_PROMPT",e.GET_PROOF_TOKEN="GET_PROOF_TOKEN",e.GET_BROWSER_INFO="GET_BROWSER_INFO",e.SSE_PART="SSE_PART",e.SSE_DONE="SSE_DONE",e.SSE_ERROR="SSE_ERROR",e.GPT_STREAM_PART="GPT_STREAM_PART",e.GPT_STREAM_DONE="GPT_STREAM_DONE",e.GPT_STREAM_ERROR="GPT_STREAM_ERROR"}(t||(t={}));const n="https://chatgpt.com",o=n+"/backend-api",i="gpt",r="clientId",s="settings";let a=null,c=null,u=null;function l(){return a}function d(e){a=e}function f(){return c}function h(e){u=e}function v(e={},t=0){return function(e={},t=null,n=0){if(crypto.randomUUID&&!t&&!e.random&&!e.rng)return crypto.randomUUID();const o=e.random||(e.rng||(()=>{const e=new Uint8Array(16);return crypto.getRandomValues(e),e}))();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){for(let e=0;e<16;++e)t[n+e]=o[e];return t}return function(e,t=0){return _[e[t+0]]+_[e[t+1]]+_[e[t+2]]+_[e[t+3]]+"-"+_[e[t+4]]+_[e[t+5]]+"-"+_[e[t+6]]+_[e[t+7]]+"-"+_[e[t+8]]+_[e[t+9]]+"-"+_[e[t+10]]+_[e[t+11]]+_[e[t+12]]+_[e[t+13]]+_[e[t+14]]+_[e[t+15]]}(o)}(e,null,t)}const _=Array.from({length:256},((e,t)=>(t+256).toString(16).slice(1)));function g(t){return Object.assign({type:e.FROM_BG},t)}function m(e){return e.replace(`${i}_`,"")}function p(e){return`${i}_${e}`}var y=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function T(e,t,n){const o=g(Object.assign({action:t},n));return chrome.tabs.sendMessage(e,o)}const E={messageCount:20,splitConversation:!1,isHideConversation:!1,explainConversation:"explain",explainMessageCount:20,explainIsHideConversation:!1,tranConversation:"tran",tranMessageCount:20,tranIsHideConversation:!1,customConversation:"custom",customMessageCount:20,customIsHideConversation:!1,theme:"system"};var O,R=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function C(){return R(this,void 0,void 0,(function*(){return(yield function(e){return R(this,void 0,void 0,(function*(){const t=p(e),n=yield w(t);return{[e]:n[t]}}))}(r)).clientId||""}))}function w(e){return new Promise(((t,n)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?n(chrome.runtime.lastError):t(e)}))}))}function S(){return R(this,void 0,void 0,(function*(){try{const e=yield C();if(e)return e;const t=v();return yield function(e){return R(this,void 0,void 0,(function*(){return yield chrome.storage.local.set({[p(r)]:e}),e}))}(t),t}catch(e){throw e}}))}function N(e){const t={};for(const n in e){const o=e[n];t[p(n)]=o}chrome.storage.local.set(t)}!function(e){e.TRAN="tran",e.EXPLAIN="explain",e.CUSTOM="custom"}(O||(O={}));var P=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};function I(e){return P(this,void 0,void 0,(function*(){var r,a,c,u,f;try{const[h]=yield chrome.tabs.query({active:!0,currentWindow:!0}),_=h.id,p=yield function(){return R(this,void 0,void 0,(function*(){const e=yield w(null),t={};for(const n in e)n.startsWith(i)&&(t[m(n)]=e[n]);return t}))}(),S=yield function(){return R(this,void 0,void 0,(function*(){const e=yield w(s);return(null==e?void 0:e.settings)?e.settings:E}))}();if(!(yield function(e,n){return P(this,void 0,void 0,(function*(){return!(!e.authorization||!e.oaiClientVersion)||(M(),yield T(n,t.SSE_PART,{error:!0,content:"Thiếu token. Hãy đăng nhập lại chatgpt."}),!1)}))}(p,_)))return{error:"Thiếu token hoặc headers. Đang mở ChatGPT để lấy lại..."};let I=function(e,t,n){const o="client-created-root",i={[O.TRAN]:{prefix:"tran"},[O.EXPLAIN]:{prefix:"explain"},[O.CUSTOM]:{prefix:"custom"}};let r="";if(e.splitConversation){r=i[n].prefix}const s=t,a=e;let c=s[A(r,"conversation_id")]||void 0,u=s[A(r,"current_message_id")]||o,l=s[A(r,"message_count")]?parseInt(s[A(r,"message_count")]):0,d=a[A(r,"isHideConversation",!0)];const f=a[A(r,"messageCount",!0)];let h=A(r,"conversation_id"),v=A(r,"current_message_id"),_=A(r,"message_count"),g=c,m=!1;l>f&&(c=void 0,u=o,l=0,m=!!d);return{conversationId:c,oldConversationId:g,messageCount:l,currentMessageId:u,conversationIdKey:h,currentMessageIdKey:v,messageCountKey:_,isHideConversation:m}}(S,p,e.promptType);const x=v(),b=function(e){e&&!e.startsWith("Bearer ")&&(e="Bearer "+e);return{Accept:"application/json","Content-Type":"application/json",Authorization:`${e}`,origin:n,referer:`${n}/`}}(p.authorization),k=function(e){const t={};t["oai-client-version"]=e.oaiClientVersion,e.userAgent&&(t["User-Agent"]=e.userAgent);e.oaiLanguage&&(t["oai-language"]=e.oaiLanguage);return e["oai-device-id"]=e.clientId,t}(p);let F=Object.assign(Object.assign(Object.assign({},b),k),{Accept:"text/event-stream"});I.isHideConversation&&(yield function(e,t){return P(this,void 0,void 0,(function*(){if(!e)return null;const n={is_visible:!1},i=yield fetch(`${o}/conversation/${e}`,{method:"PATCH",headers:t,body:JSON.stringify(n),credentials:"include"});if(!i.ok){let e=null;try{e=yield i.json(),(null==e?void 0:e.detail)&&(e=e.detail)}catch(t){e=yield i.text()}throw new Error(e||"Failed to hide conversation")}return i.json()}))}(I.oldConversationId,F),yield function(e,t){return R(this,void 0,void 0,(function*(){t=Array.isArray(t)?t.map((t=>e+"_"+t)):e+"_"+t,yield chrome.storage.local.remove(t)}))}(i,[I.conversationIdKey,I.currentMessageIdKey]));const G=yield function(e){return P(this,void 0,void 0,(function*(){yield C();const t=yield fetch(`${o}/sentinel/chat-requirements`,{method:"POST",headers:e,body:JSON.stringify({conversationMode:{kind:"primary_assistant"}})});if(!t.ok){let e=null;try{e=yield t.json(),(null==e?void 0:e.detail)&&(e=e.detail)}catch(n){e=yield t.text()}throw new Error(e||"Failed to fetch chat requirements")}return t.json()}))}(F);F["openai-sentinel-chat-requirements-token"]=G.token;const H=yield(u=G.proofofwork.seed,f=G.proofofwork.difficulty,new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(n=>{var o;(null===(o=n[0])||void 0===o?void 0:o.id)?T(n[0].id,t.GET_PROOF_TOKEN,{params:[u,f]}).then((t=>{e(t)})).catch((t=>{console.log("getProofToken err",t),e("")})):e("")}))})));if(!H)return{error:"Thiếu proofToken. Hãy thử lại..."};F["openai-sentinel-proof-token"]=H;const j=yield function(){return y(this,void 0,void 0,(function*(){let e=l();return e||new Promise((n=>{const o=setTimeout((()=>{e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},d(e),n(e)}),1e3);chrome.tabs.query({active:!0,currentWindow:!0},(i=>{if(chrome.runtime.lastError||!i.length)return clearTimeout(o),e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},d(e),n(e);chrome.tabs.sendMessage(i[0].id,g({action:t.GET_BROWSER_INFO}),(t=>{if(clearTimeout(o),chrome.runtime.lastError||!t)return e={page_height:953,page_width:1920,pixel_ratio:1,screen_height:1080,screen_width:1920},d(e),n(e);e=t,n(t)}))}))}))}))}(),D=function(e,t,n,o,i){return{action:"next",messages:[{id:i,author:{role:"user"},create_time:Date.now()/1e3,content:{content_type:"text",parts:[e.prompt]},metadata:{selected_github_repos:[],selected_all_github_repos:!1,serialization_metadata:{custom_symbol_offsets:[]}}}],parent_message_id:o,model:"auto",timezone_offset_min:(new Date).getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,conversation_id:n,conversation_mode:{kind:"primary_assistant"},enable_message_followups:!0,system_hints:[],supports_buffering:!0,supported_encodings:["v1"],client_contextual_info:{is_dark_mode:!0,time_since_loaded:performance.now()/1e3,page_height:t.page_height,page_width:t.page_width,pixel_ratio:t.pixel_ratio,screen_height:t.screen_height,screen_width:t.screen_width},paragen_cot_summary_display_override:"allow"}}(e,j,I.conversationId,I.currentMessageId,x),L=yield fetch(`${o}/conversation`,{method:"POST",headers:F,body:JSON.stringify(D),credentials:"include"});if(401===L.status)return M(),{error:"Token expired, opened chatgpt.com to refresh token"};const K=L.headers.get("content-type");if(200!==L.status){let e=null;return"application/json"===K&&(e=yield L.json()),yield T(_,t.SSE_PART,{error:!0,content:(null===(r=null==e?void 0:e.detail)||void 0===r?void 0:r.message)||(null==e?void 0:e.detail)}).catch((e=>{console.log("SendMessage lỗi:",e)})),{success:!1,error:e}}I.messageCount+=1,a=I.messageCountKey,c=I.messageCount,N({[a]:c});const $=L.body.getReader();return yield function(e,n,o){return P(this,void 0,void 0,(function*(){var i,r,s,a,c,u,l,d,f,h;const v=new TextDecoder("utf-8");let _="",g="";for(;;){const{done:m,value:p}=yield e.read();if(m)break;_+=v.decode(p,{stream:!0});const y=_.split("\n\n");_=y.pop()||"";for(const e of y){const v=e.trim().split("\n");let _=null;const m=[];for(const e of v)e.startsWith("event:")?_=e.slice(6).trim():e.startsWith("data:")&&m.push(e.slice(6).trim());const p=m.join("\n");if("[DONE]"===p)break;if(p)try{const e=JSON.parse(p);if((null===(i=e.v)||void 0===i?void 0:i.conversation_id)&&N({[o.conversationIdKey]:e.v.conversation_id}),(null===(s=null===(r=e.v)||void 0===r?void 0:r.message)||void 0===s?void 0:s.id)&&N({[o.currentMessageIdKey]:e.v.message.id}),"user"===(null===(u=null===(c=null===(a=e.v)||void 0===a?void 0:a.message)||void 0===c?void 0:c.author)||void 0===u?void 0:u.role))continue;let v=null;if((null===(h=null===(f=null===(d=null===(l=e.v)||void 0===l?void 0:l.message)||void 0===d?void 0:d.content)||void 0===f?void 0:f.parts)||void 0===h?void 0:h.length)>0)v=e.v.message.content.parts[0];else if("string"==typeof e.v)v=e.v;else if(e.p&&"append"===e.o&&"string"==typeof e.v)v=e.v;else if("patch"===(null==e?void 0:e.o)&&Array.isArray(e.v)){const t=e.v[0];"append"===t.o&&"string"==typeof t.v&&(v=t.v)}v&&(g+=v,yield T(n,t.SSE_PART,{content:v}))}catch(e){console.warn("Có lỗi xảy ra:",e)}}}return g}))}($,_,I),{success:!0}}catch(e){return console.log(e),{error:e.message||e}}}))}function M(){const e=f();null!==e?chrome.tabs.get(e,(t=>{chrome.runtime.lastError||!t?x():(chrome.tabs.reload(e),chrome.tabs.update(e,{active:!1}))})):x()}function x(){chrome.tabs.create({url:n,active:!1},(e=>{var t;void 0!==e.id&&(t=e.id,c=t)}))}function A(e,t,n=!1){if(!e)return t;if(n){return e+(t.charAt(0).toUpperCase()+t.slice(1))}return e+"_"+t}var b=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))};chrome.webRequest.onBeforeSendHeaders.addListener((e=>{const t=e.requestHeaders||[];if(e.initiator===n)return e.url===`${n}/auth/logout`&&chrome.storage.local.set({[`${i}_authorization`]:""}),function(e){const t=["authorization","oai-client-version","user-agent","accept-language","oai-language"],n={};return e.forEach((e=>{const o=(e=>e.name.toLowerCase())(e);if(t.includes(o)&&e.value){const t=e.name.toLowerCase().replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase())).replace(/ /g,"").replace(/^\w/,(e=>e.toLowerCase()));n[p(t)]=e.value}})),Object.keys(n).length>0&&chrome.storage.local.set(n),{requestHeaders:e}}(t)}),{urls:[`${n}/*`]},["requestHeaders"]),chrome.runtime.onInstalled.addListener((e=>b(void 0,void 0,void 0,(function*(){const t=yield S();h(t),console.log("ClientId initialized:",t),"install"!==e.reason&&"update"!==e.reason||chrome.tabs.create({url:chrome.runtime.getURL("settings/index.html")})})))),chrome.runtime.onStartup.addListener((()=>b(void 0,void 0,void 0,(function*(){const e=yield S();h(e),console.log("ClientId ready on startup:",e)})))),chrome.runtime.onMessage.addListener(((n,o,i)=>{if(n.type===e.FROM_CONTENT)return n.action===t.SEND_PROMPT?(I(n).then((e=>{i(e)})).catch((e=>{i({error:e.message||e})})),!0):void 0}))})();